/*===============================
          Nginx ì—…ê·¸ë ˆì´ë“œ
================================*/
# NGINX
http://nginx.org/download/nginx-1.24.0.tar.gz

tar zxvf nginx-1.24.0.tar.gz
cd nginx-1.24.0


src/http/ngx_http_header_filter_module.c

static u_char ngx_http_server_string[] = "Server: nginx" CRLF;

static u_char ngx_http_server_string[] = "" CRLF;



nginx -V

--prefix=/etc/nginx --sbin-path=/usr/sbin/nginx --conf-path=/etc/nginx/nginx.conf ...


# Ubuntu
sudo apt install build-essential libpcre3 libpcre3-dev zlib1g-dev libssl-dev

# CentOS
sudo yum install gcc pcre-devel zlib-devel openssl-devel make

cd nginx-1.24.0
./configure \
  --prefix=/etc/nginx \
  --sbin-path=/usr/sbin/nginx \
  --conf-path=/etc/nginx/nginx.conf \
  --error-log-path=/var/log/nginx/error.log \
  --http-log-path=/var/log/nginx/access.log \
  --pid-path=/var/run/nginx.pid \
  --lock-path=/var/lock/nginx.lock \
  --with-http_ssl_module \
  --with-http_stub_status_module \
  --with-threads


make

tar czvf nginx-compiled.tar.gz objs/nginx



sudo systemctl stop nginx

# ê¸°ì¡´ ë°±ì—…
sudo cp /usr/sbin/nginx /usr/sbin/nginx.bak

# ìƒˆ ì‹¤í–‰íŒŒì¼ ë®ì–´ì“°ê¸°
sudo cp nginx-compiled/nginx /usr/sbin/nginx
sudo chmod +x /usr/sbin/nginx

# ì„¤ì • í…ŒìŠ¤íŠ¸
sudo nginx -t

# ì¬ì‹œì‘
sudo systemctl start nginx





/*===============================
          nginx ë³´ì•ˆì¡°ì¹˜
================================*/
---
## âœ… **1. ì„œë²„ ì •ë³´ ë…¸ì¶œ ì°¨ë‹¨ (ì„œë²„ ë²„ì „ ìˆ¨ê¸°ê¸°)**
### ğŸ”’ ëª©ì : HTTP í—¤ë” ë˜ëŠ” ì—ëŸ¬ í˜ì´ì§€ì—ì„œ Nginx ë²„ì „ ë…¸ì¶œ ì°¨ë‹¨

```nginx
# nginx.conf (http ë¸”ë¡ ë‚´ë¶€)
server_tokens off;
```

- ì ìš© íš¨ê³¼: `Server: nginx/1.14.1` â†’ `Server: nginx`
- ì—ëŸ¬ í˜ì´ì§€ì—ì„œ ë²„ì „ ë…¸ì¶œë„ ì°¨ë‹¨ë¨

---

## âœ… **2. ì—ëŸ¬ í˜ì´ì§€ ì»¤ìŠ¤í„°ë§ˆì´ì§• (ë””í´íŠ¸ ë©”ì‹œì§€ ì œê±°)**
### ğŸ”’ ëª©ì : Nginx ê¸°ë³¸ ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ í†µí•œ ì •ë³´ ë…¸ì¶œ ë°©ì§€

```nginx
# nginx.conf ë˜ëŠ” server ë¸”ë¡
error_page 404 /custom_404.html;
error_page 500 502 503 504 /custom_50x.html;

location = /custom_404.html {
    root /etc/nginx/html;
    internal;
}
location = /custom_50x.html {
    root /etc/nginx/html;
    internal;
}
```

- `/etc/nginx/html/` í´ë”ì— ì ì ˆí•œ ì‚¬ìš©ì ì •ì˜ ì—ëŸ¬ í˜ì´ì§€ íŒŒì¼ ìƒì„± í•„ìš”

---

## âœ… **3. ë””í´íŠ¸ ì„¤ì • ì œê±° (`autoindex`, ë””ë ‰í† ë¦¬ ë…¸ì¶œ ì°¨ë‹¨)**
### ğŸ”’ ëª©ì : íŒŒì¼ ëª©ë¡ ìë™ ë…¸ì¶œ ë°©ì§€

```nginx
# ëª¨ë“  location ë¸”ë¡ ë˜ëŠ” server ë¸”ë¡ ë‚´ì— ì‚½ì…
autoindex off;
```

---

## âœ… **4. ë¡œê·¸ ì •ë³´ ìµœì†Œí™” ë˜ëŠ” í—¤ë” ë§ˆìŠ¤í‚¹**
### ğŸ”’ ëª©ì : ë¯¼ê° ì •ë³´ê°€ access/error ë¡œê·¸ì— ë‚¨ì§€ ì•Šë„ë¡ ì„¤ì •

```nginx
# nginx.conf (log_formatì„ ê°„ê²°í•˜ê²Œ)
log_format minimal '$remote_addr - $remote_user [$time_local] '
                   '"$request" $status $body_bytes_sent '
                   '"$http_user_agent"';

access_log /var/log/nginx/access.log minimal;
```

ğŸš« `referer`, `cookie`, `authorization`, ì‚¬ìš©ì ì •ì˜ í—¤ë” ë“±ì€ í¬í•¨í•˜ì§€ ì•Šë„ë¡ ê´€ë¦¬

---

## âœ… **5. ìš”ì²­ í¬ê¸° ì œí•œ (DoS ë°©ì–´)**
```nginx
# nginx.conf (http ë¸”ë¡)
client_max_body_size 2M;
```
- í´ë¼ì´ì–¸íŠ¸ê°€ ë„ˆë¬´ í° íŒŒì¼ì„ ë³´ë‚´ê±°ë‚˜ ê³µê²© ì‹œë„ë¥¼ ë§‰ê¸° ìœ„í•œ ì„¤ì •

---

## âœ… **6. ë²„í¼ ì‚¬ì´ì¦ˆ ì œí•œ (HTTP Header Flood ë°©ì–´)**
```nginx
# nginx.conf (http ë˜ëŠ” server ë¸”ë¡)
client_body_buffer_size 16k;
client_header_buffer_size 1k;
large_client_header_buffers 2 4k;
```
- ë¹„ì •ìƒì ì¸ ëŒ€ìš©ëŸ‰ ìš”ì²­ì„ ë°©ì–´í•  ìˆ˜ ìˆìŒ

---

## âœ… **7. í—ˆìš©ëœ ë©”ì„œë“œ ì œí•œ**
### ğŸ”’ ëª©ì : ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ë©”ì„œë“œ(GET, POST ì™¸) ì°¨ë‹¨

```nginx
location / {
    limit_except GET POST {
        deny all;
    }

    proxy_pass http://was.internal.com;
}
```

---

## âœ… **8. SSL/TLS ê´€ë ¨ (HTTPS ì‚¬ìš© ì¤‘ì´ë¼ë©´ í•„ìˆ˜)**
HTTPS í™˜ê²½ì´ë¼ë©´ ë‹¤ìŒë„ í•„ìˆ˜ ì¡°ì¹˜ì…ë‹ˆë‹¤:

```nginx
ssl_protocols TLSv1.2 TLSv1.3;  # TLS 1.0/1.1 ì‚¬ìš© ê¸ˆì§€
ssl_prefer_server_ciphers on;
ssl_ciphers 'EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH';
```

---

## âœ… **9. Referrer Policy ë“± ë³´ì•ˆ í—¤ë” ì¶”ê°€ (ì„ íƒ)**
```nginx
add_header X-Content-Type-Options nosniff always;
add_header X-Frame-Options SAMEORIGIN always;
add_header X-XSS-Protection "1; mode=block" always;
```

---

## âœ… **10. ë””ë²„ê¹… ì •ë³´ ë…¸ì¶œ ì°¨ë‹¨**
**í™•ì¸ ì‚¬í•­:**  
- `debug` ì˜µì…˜ì´ ì„¤ì •ë˜ì–´ ìˆì§€ ì•Šì€ì§€ í™•ì¸ (`error_log` ë˜ëŠ” `access_log`)
- `if ($args ~ debug)` ê°™ì€ URL íŠ¸ë¦¬ê±° ë””ë²„ê¹… ì½”ë“œ ì œê±°

---

## ğŸ§  **ë³´ì•ˆ ì„¤ì • ì ìš© í›„ ì ê²€**
```bash
sudo nginx -t
sudo systemctl reload nginx
```

---

## ğŸš¨ ì£¼ì˜: Nginx 1.14.1ì€ ì˜¤ë˜ëœ ë²„ì „!
- **ì´ë¯¸ ì•Œë ¤ì§„ ì·¨ì•½ì (CVE)ì´ ì¡´ì¬í•¨** (ì˜ˆ: request smuggling, buffer overflow ë“±)
- ì‚¬ë‚´ ì •ì±…ì— ë”°ë¼ ê°€ëŠ¥í•˜ë‹¤ë©´ **1.18 ë˜ëŠ” 1.22 LTS ë²„ì „ ì´ìƒìœ¼ë¡œ ì—…ê·¸ë ˆì´ë“œ ê¶Œì¥**

---

## âœ… ì •ë¦¬: ì¦‰ì‹œ ì ìš©í•  ë³´ì•ˆ ì¡°ì¹˜ ëª©ë¡

| êµ¬ë¶„ | ì¡°ì¹˜ ë‚´ìš© |
|------|----------|
| ì •ë³´ ë…¸ì¶œ ì°¨ë‹¨ | `server_tokens off`, ì—ëŸ¬ í˜ì´ì§€ ì»¤ìŠ¤í„°ë§ˆì´ì§• |
| ë””ë ‰í† ë¦¬ ë³´í˜¸ | `autoindex off` |
| ë¡œê·¸ ë³´ì•ˆ | `log_format` ë‹¨ìˆœí™”, ë¯¼ê° ì •ë³´ ì œê±° |
| ìš”ì²­ ì œí•œ | `client_max_body_size`, í—¤ë” ë²„í¼ ì œí•œ |
| ë©”ì„œë“œ ì œí•œ | `limit_except GET POST` |
| SSL ê°•í™” | `ssl_protocols`, `ssl_ciphers` (HTTPS ì ìš© ì‹œ) |
| ë³´ì•ˆ í—¤ë” | `X-Frame-Options`, `X-Content-Type-Options` ë“± |
| ë””ë²„ê·¸ ì œê±° | `debug` ë¡œê·¸ ë° ë””ë²„ê¹… íŠ¸ë¦¬ê±° ì œê±° |

---
ì¶”ê°€ë¡œ **ì·¨ì•½ì  ìŠ¤ìº” ë„êµ¬(nikto, Nessus ë“±




sudo vi /etc/nginx/includes/proxy_cache_security.conf


# proxy_cache ë³´ì•ˆ ì„¤ì • (ê³µí†µ)

# í”„ë¡ì‹œ ì„œë²„ê°€ ì‘ë‹µí•œ í—¤ë”ë¡œ ì¸í•œ ìºì‹œ ë¶„ê¸° ë°©ì§€
proxy_hide_header Vary;
proxy_ignore_headers Expires Cache-Control;

# Host í—¤ë” ê³ ì •
proxy_set_header Host $host;
proxy_set_header X-Forwarded-Host $host;

# ì¿ í‚¤ ìˆëŠ” ìš”ì²­ì€ ìºì‹œ ì•ˆ í•¨
proxy_no_cache $cookie_session;
proxy_cache_bypass $cookie_session;

# ìºì‹œ í‚¤ ë‹¨ìˆœí™”
proxy_cache_key "$scheme$host$request_uri";

# ì˜¤ì—¼ëœ ìºì‹œ ì˜¤ë˜ ìœ ì§€ë˜ì§€ ì•Šë„ë¡ ë§Œë£Œ ê°•ì œ
proxy_cache_valid 200 302 10m;
proxy_cache_valid 404 1m;

# ìºì‹œ ìƒíƒœë¥¼ ì‘ë‹µ í—¤ë”ë¡œ í™•ì¸í•  ìˆ˜ ìˆê²Œ
add_header X-Cache-Status $upstream_cache_status;

# (ì„ íƒ) ìºì‹œ ì˜ì—­ ì„¤ì • (nginx.conf ìª½ http {} ë¸”ë¡ì— ì„ ì–¸)
# proxy_cache my_cache;  <= ì´ê±´ server ë¸”ë¡ì—ì„œ ì„ ì–¸í•˜ê±°ë‚˜, ë¯¸ë¦¬ ì„ ì–¸ í•„ìš”



nginx.conf
http {
    ...

    # ìºì‹œ ì €ì¥ì†Œ ì •ì˜ (10MB ë©”ëª¨ë¦¬ zone, 10ë¶„ ë¹„í™œì„±ì‹œ ì‚­ì œ)
    proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=my_cache:10m inactive=10m use_temp_path=off;
}



server ë¸”ë¡
server {
    listen 80;
    server_name site1.example.com;

    location / {
        proxy_pass http://backend1;
        proxy_cache my_cache;

        include /etc/nginx/includes/proxy_cache_security.conf;
    }
}

sudo nginx -t
sudo systemctl reload nginx





**[NGINX ë³´ì•ˆ ì¡°ì¹˜ ë° ì—…ê·¸ë ˆì´ë“œ ì •ë¦¬ ë¬¸ì„œ]**

**1. ëª©ì  ë° ê°œìš”**
ê¸°ì¡´ ìš´ì˜ ì¤‘ì¸ NGINX 1.14.1ì€ ë³´ì•ˆ ì·¨ì•½ì (CVE) ë° ì •ë³´ ë…¸ì¶œ ê°€ëŠ¥ì„±ì´ ì¡´ì¬í•˜ì—¬, ì´ë¥¼ ê°œì„ í•˜ê³ ì ìµœì‹  ì•ˆì • ë²„ì „(NGINX 1.24.0)ìœ¼ë¡œ ì—…ê·¸ë ˆì´ë“œí•˜ê³ , ì‹¤ë¬´ ìˆ˜ì¤€ì˜ ë³´ì•ˆ ì„¤ì •ì„ ì ìš©í•¨.

---

**2. ì—…ê·¸ë ˆì´ë“œ ë‚´ìš© ìš”ì•½**
- ê¸°ì¡´ ë²„ì „: NGINX 1.14.1 (íŒ¨í‚¤ì§€ ì„¤ì¹˜ ê¸°ë°˜)
- ì—…ê·¸ë ˆì´ë“œ ë²„ì „: NGINX 1.24.0 (ì†ŒìŠ¤ ì§ì ‘ ì»´íŒŒì¼)
- ì—…ê·¸ë ˆì´ë“œ ë°©ì‹: íì‡„ë§ í™˜ê²½ì—ì„œ ì†ŒìŠ¤ ìˆ˜ì • ë° ë‚´ë¶€ ì¬ì»´íŒŒì¼ í›„ `/usr/sbin/nginx` êµì²´

---

**3. ì£¼ìš” ì ìš© ë³´ì•ˆ ì„¤ì •**

**[1] ë²„ì „/ì„œë²„ ì •ë³´ ë…¸ì¶œ ì°¨ë‹¨**
- `server_tokens off;` ì„¤ì •ìœ¼ë¡œ ë²„ì „ ìˆ¨ê¹€
- NGINX ì†ŒìŠ¤ ì½”ë“œ ë‚´ `ngx_http_header_filter_module.c` ìˆ˜ì •ìœ¼ë¡œ `Server` í—¤ë” ì œê±° (`"Server: nginx"` â†’ ì œê±°)

**[2] ë³´ì•ˆ í—¤ë” ì¶”ê°€**
```nginx
add_header X-Content-Type-Options nosniff always;
add_header X-Frame-Options SAMEORIGIN always;
add_header X-XSS-Protection "1; mode=block" always;
```

**[3] ë””ë ‰í† ë¦¬ ìë™ ì¸ë±ì‹± ì°¨ë‹¨**
```nginx
autoindex off;
```

**[4] ìš”ì²­ í¬ê¸° ë° ë²„í¼ ì œí•œ ì„¤ì • (DoS ë°©ì–´)**
```nginx
client_max_body_size 2M;
client_body_buffer_size 16k;
client_header_buffer_size 1k;
large_client_header_buffers 2 4k;
```

**[5] ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” HTTP ë©”ì„œë“œ ì œí•œ**
```nginx
limit_except GET POST {
    deny all;
}
```

**[6] ìºì‹œ ì˜¤ì—¼ ë°©ì§€ ì„¤ì • (Reverse Proxy Cache Hardening)**
- ëª¨ë“  í”„ë¡ì‹œ ì„œë²„ì— ê³µí†µ ë³´ì•ˆ ìºì‹œ ì„¤ì • ì ìš© (proxy_cache ë³´ì•ˆ ë¶„ë¦¬ íŒŒì¼ë¡œ ê´€ë¦¬)
```nginx
proxy_cache_key "$scheme$host$request_uri";
proxy_set_header Host $host;
proxy_set_header X-Forwarded-Host $host;
proxy_hide_header Vary;
proxy_ignore_headers Expires Cache-Control;
proxy_no_cache $cookie_session;
proxy_cache_bypass $cookie_session;
proxy_cache_valid 200 302 10m;
proxy_cache_valid 404 1m;
add_header X-Cache-Status $upstream_cache_status;
```
- ê³µí†µ ì„¤ì •ì„ `/etc/nginx/includes/proxy_cache_security.conf` ë¡œ ë¶„ë¦¬í•˜ì—¬ `include` ë°©ì‹ìœ¼ë¡œ ê° `server/location`ì— ì¼ê´„ ì ìš©
- `proxy_cache_path`ëŠ” nginx.conf ì˜ `http` ë¸”ë¡ì— ì •ì˜:
```nginx
proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=my_cache:10m inactive=10m use_temp_path=off;
```

---

**4. ë³´ì•ˆ ì·¨ì•½ì (CVE) ëŒ€ì‘ ì‚¬í•­ ì •ë¦¬**

| CVE ë²ˆí˜¸ | ì„¤ëª… | ì˜í–¥ ì—¬ë¶€ | ì¡°ì¹˜ ë‚´ì—­ |
|----------|------|------------|------------|
| CVE-2019-20372 | LDAP ì¸ì¦ ìš°íšŒ (nginx-ldap-auth daemon ì‚¬ìš© ì‹œ) | ì˜í–¥ ì—†ìŒ (ë¯¸ì‚¬ìš©) | LDAP ì¸ì¦ ë¯¸ì‚¬ìš© ë˜ëŠ” ìµœì‹  ldap-auth ì ìš© |
| CVE-2021-23017 | DNS ì²˜ë¦¬ RCE ì·¨ì•½ì  (1.20.1 ë¯¸ë§Œ) | ì˜í–¥ ì—†ìŒ | 1.24.0 ì—…ê·¸ë ˆì´ë“œë¡œ ìë™ í•´ê²° |

---

**5. ê¸°íƒ€**
- `nginx -V` ê¸°ì¤€ ê¸°ì¡´ ì„¤ì • ì˜µì…˜ ê·¸ëŒ€ë¡œ ìœ ì§€í•˜ì—¬ ì„¤ì • í˜¸í™˜ì„± í™•ë³´
- ì •ì  ëª¨ë“ˆ(`http_sub_module`, `http_ssl_module`, `http_stub_status_module`) í¬í•¨ ë¹Œë“œ
- ë™ì  ëª¨ë“ˆ ì¤‘ ë¶ˆí•„ìš”í•œ `.so` íŒŒì¼ ì œê±° ë˜ëŠ” ë¹„í™œì„±í™” ì²˜ë¦¬ (ì˜ˆ: `perl`, `xslt`, `image_filter` ë“±)

---

**6. ê²°ë¡  ë° ìš´ì˜ ê°€ì´ë“œ**
- í˜„ì¬ ë²„ì „ì€ ìµœì‹  ì•ˆì • ë²„ì „(1.24.0) ê¸°ì¤€ìœ¼ë¡œ ëª¨ë“  ì‹¬ê°ë„ ë†’ì€ CVE ì·¨ì•½ì  íŒ¨ì¹˜ í¬í•¨ë¨
- ë³´ì•ˆ í—¤ë”, ìºì‹œ í•˜ë“œë‹, ì •ë³´ ë…¸ì¶œ ì°¨ë‹¨ ë“±ì„ ì ìš©í•˜ì—¬ ìš´ì˜ ì¤‘
- í–¥í›„ ë³´ì•ˆ ì ê²€ ì‹œ, í•´ë‹¹ í•­ëª© ì ìš© ì—¬ë¶€ ì²´í¬ë¦¬ìŠ¤íŠ¸ë¡œ í™œìš© ê°€ëŠ¥


